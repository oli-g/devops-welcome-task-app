# DevOps Welcome Task

This repo contains an exercise for a DevOps interview. I've been requested to deploy a Docker service on Amazon with ECS, and to add a simple autoscaling mechanism: so I used Lambda to execute an autoscaling action in case of alert generated by CloudWatch metrics.

## Docker service

The service consists of a simple Go HTTP server, that can be launched through Docker with:

    docker run -p="80:8080" olinicola/devops-welcome-task-app:latest

## ECS Task Definition

```
{
  "family": "devops-welcome-task-app",
  "containerDefinitions": [
    {
      "name": "web",
      "image": "olinicola/devops-welcome-task-app:latest",
      "cpu": "20",
      "memory": "100",
      "environment": [],
      "portMappings": [
        {
          "hostPort": "80",
          "containerPort": "8080"
        }
      ],
      "volumesFrom": [],
      "mountPoints": [],
      "essential": true
    }
  ],
  "volumes": []
}
```

## Lamba Function

```
console.log('Loading event');
var aws = require('aws-sdk');
 
exports.handler = function(event, context) {
  var ecsService = 'devops-welcome-task';
  var ecsRegion = 'eu-west-1';
  var maxCount = 4;
 
  var ecs = new aws.ECS({region: ecsRegion});
  ecs.describeServices({services:[ecsService]}, function(err, data) {
    if (err) {
      console.log(err, err.stack);
    } else {
      var desiredCount = data.services[0].desiredCount;
      if (desiredCount < maxCount) {
        desiredCount++;
        var params = {
          service:      ecsService,
          desiredCount: desiredCount
        };
        ecs.updateService(params, function(err, data) {
          if (err) {
            console.log(err, err.stack);
          } else {
            console.log(data);
            context.succeed();
          }
        });
      } else {
        console.log('Service count is already max.');
        context.fail();
      }
    }
  });
};
```

## Resources:

* https://aws.amazon.com/blogs/compute/scaling-amazon-ecs-services-automatically-using-amazon-cloudwatch-and-aws-lambda/
* http://docs.aws.amazon.com/AmazonECS/latest/developerguide/get-set-up-for-amazon-ecs.html
* http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_GetStarted.html
* http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_CleaningUp.html
* http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Introduction.html
